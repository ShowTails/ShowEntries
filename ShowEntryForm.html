<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rabbit Show Entry</title>

  <style>
    :root { --border: #111; --muted: #f2f2f2; }
    body { font-family: Arial, Helvetica, sans-serif; margin: 18px; color:#000; }
    .header { text-align:center; }
    .header h1 { font-size: 20px; margin: 0 0 6px; }
    .header .meta { font-size: 12px; margin: 0 0 14px; }

    .grid {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 18px;
      font-size: 12px;
      margin: 10px 0 14px;
    }
    .field { line-height: 1.35; }
    .label { font-weight: 700; }
    .value { border-bottom: 1px solid #aaa; padding: 0 0 1px; display:inline-block; min-width: 120px; }

    table { width:100%; border-collapse: collapse; font-size: 11px; }
    th, td { border: 1px solid var(--border); padding: 4px 6px; }
    th { background: var(--muted); text-align:center; font-weight:700; }
    td { text-align:center; vertical-align: middle; }
    td.left { text-align:left; }
    .x { font-weight: 700; }

    .totals {
      display:flex;
      justify-content: flex-end;
      margin-top: 10px;
      font-size: 12px;
      font-weight: 700;
      gap: 8px;
    }

    .footer {
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
      font-size: 11px;
    }
    .line { border-bottom: 1px solid #000; height: 14px; }

    @media print {
      body { margin: 0.5in; }
      a { color:#000; text-decoration:none; }
    }
  </style>
</head>

<body>
  <div class="header">
    <h1 id="showName"></h1>
    <div class="meta">
      <span id="hostingClub"></span> •
      <span id="showDate"></span> •
      <span id="showType"></span> •
      Shows: <span id="showIds"></span>
    </div>
  </div>

  <div class="grid">
    <div class="field"><span class="label">Exhibitor:</span> <span class="value" id="exhibitorName"></span></div>
    <div class="field"><span class="label">Phone:</span> <span class="value" id="exhibitorPhone"></span></div>
    <div class="field"><span class="label">Address:</span> <span class="value" id="exhibitorAddress"></span></div>
    <div class="field"><span class="label">Email:</span> <span class="value" id="exhibitorEmail"></span></div>
  </div>

  <table>
    <thead>
      <tr>
        <th style="width:34px;">#</th>
        <th>Breed</th>
        <th>Variety</th>
        <th style="width:90px;">Ear/Tattoo</th>
        <th style="width:60px;">Class</th>
        <th style="width:60px;">Sex</th>
        <th style="width:34px;">A</th>
        <th style="width:34px;">B</th>
        <th style="width:34px;">C</th>
        <th style="width:34px;">D</th>
        <th style="width:70px;">Fee</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>

  <div class="totals">
    <div>Total owed for all entries:</div>
    <div>$<span id="totalOwed">0.00</span></div>
  </div>

  <div class="footer">
    <div>
      <div><strong>Exhibitor Signature</strong></div>
      <div class="line"></div>
    </div>
    <div>
      <div><strong>Date</strong></div>
      <div class="line"></div>
    </div>
  </div>

<script>
  const qs = new URLSearchParams(window.location.search);

  const get = (k) => (qs.get(k) || "").trim();
  const money = (n) => (Math.round((n + Number.EPSILON) * 100) / 100).toFixed(2);

  // Header fields
  document.getElementById("showName").textContent = get("show_name");
  document.getElementById("hostingClub").textContent = get("hosting_club");
  document.getElementById("showDate").textContent = get("show_date");
  document.getElementById("showType").textContent = get("show_type");
  document.getElementById("showIds").textContent = get("show_ids");

  // Exhibitor fields
  document.getElementById("exhibitorName").textContent = get("exhibitor_name");
  document.getElementById("exhibitorAddress").textContent = get("exhibitor_address");
  document.getElementById("exhibitorEmail").textContent = get("exhibitor_email");
  document.getElementById("exhibitorPhone").textContent = get("exhibitor_phone");

  // Determine which show identifiers are in play (A/B/C/D)
  const enabledShows = new Set(
    (get("show_ids") || "")
      .split(",")
      .map(s => s.trim().toUpperCase())
      .filter(Boolean)
  );

  const tbody = document.getElementById("rows");
  let total = 0;

  function hasAnyRabbitData(i) {
    return (
      get(`r${i}_breed`) ||
      get(`r${i}_variety`) ||
      get(`r${i}_ear`) ||
      get(`r${i}_class`) ||
      get(`r${i}_sex`) ||
      get(`r${i}_shows`) ||
      get(`r${i}_fee`)
    );
  }

  function showMarks(i) {
    const selected = new Set(
      (get(`r${i}_shows`) || "")
        .split(",")
        .map(s => s.trim().toUpperCase())
        .filter(Boolean)
    );

    const mark = (letter) => {
      if (!enabledShows.has(letter)) return ""; // show not offered
      return selected.has(letter) ? '<span class="x">X</span>' : "";
    };

    return {
      A: mark("A"),
      B: mark("B"),
      C: mark("C"),
      D: mark("D"),
    };
  }

  // Render up to 20 rabbits; only add rows that have data
  let rowNum = 0;

  for (let i = 1; i <= 20; i++) {
    if (!hasAnyRabbitData(i)) continue;

    rowNum++;
    const breed = get(`r${i}_breed`);
    const variety = get(`r${i}_variety`);
    const ear = get(`r${i}_ear`);
    const rclass = get(`r${i}_class`);
    const sex = get(`r${i}_sex`);
    const feeRaw = get(`r${i}_fee`);
    const fee = Number(feeRaw || 0);

    const marks = showMarks(i);

    // Accumulate total (only if fee is a valid number)
    if (!Number.isNaN(fee)) total += fee;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${rowNum}</td>
      <td class="left">${escapeHtml(breed)}</td>
      <td class="left">${escapeHtml(variety)}</td>
      <td>${escapeHtml(ear)}</td>
      <td>${escapeHtml(rclass)}</td>
      <td>${escapeHtml(sex)}</td>
      <td>${marks.A}</td>
      <td>${marks.B}</td>
      <td>${marks.C}</td>
      <td>${marks.D}</td>
      <td>$${money(Number.isNaN(fee) ? 0 : fee)}</td>
    `;
    tbody.appendChild(tr);
  }

  // If Glide sends total_owed, you can choose to display that instead:
  // const passedTotal = get("total_owed");
  // document.getElementById("totalOwed").textContent = passedTotal ? money(Number(passedTotal)) : money(total);

  document.getElementById("totalOwed").textContent = money(total);

  // Basic escaping to prevent HTML injection from query params
  function escapeHtml(str) {
    return (str || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }
</script>
</body>
</html>
